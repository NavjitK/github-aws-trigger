version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8
    commands:
      - curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
      - sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
      - sudo apt-get update
      - sudo apt-get install terraform
      - terraform --version
      - echo "Install phase"
  pre_build:
    commands:
      - echo "Pre-build phase"
  build:
    commands:
      # Initialize Terraform (use appropriate version)
      - terraform --version
      - terraform init
      # Plan the Terraform changes (without applying)
      - terraform plan -out=tfplan
  post_build:
    commands:
      # Show the plan
      - terraform show tfplan
      # Optionally, you can parse the output to determine the state programmatically
      # Example: Check if there are any changes proposed by Terraform
      - |
        if terraform show -json tfplan | jq '.resource_changes | length' | grep -Eq '^[0-9]+$'; then
            echo "There are changes proposed by Terraform."
            # You can trigger further actions here if needed
        else
            echo "No changes proposed by Terraform."
        fi
